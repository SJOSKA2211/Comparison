Starting tests...
============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-9.0.2, pluggy-1.6.0 -- /app/.venv/bin/python
cachedir: .pytest_cache
rootdir: /app
configfile: pyproject.toml
plugins: asyncio-1.3.0, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 34 items

tests/test_auth.py::TestUserModels::test_user_create_valid FAILED        [  2%]
tests/test_auth.py::TestUserModels::test_user_create_default_role FAILED [  5%]
tests/test_auth.py::TestUserModels::test_user_create_invalid_email FAILED [  8%]
tests/test_auth.py::TestUserModels::test_user_create_short_password FAILED [ 11%]
tests/test_auth.py::TestUserModels::test_user_create_invalid_role FAILED [ 14%]
tests/test_auth.py::TestPricingModels::test_pricing_request_valid FAILED [ 17%]
tests/test_auth.py::TestPricingModels::test_pricing_request_invalid_spot FAILED [ 20%]
tests/test_auth.py::TestPricingModels::test_pricing_request_invalid_option_type FAILED [ 23%]
tests/test_auth.py::TestOAuthUrls::test_google_oauth_url_structure PASSED [ 26%]
tests/test_auth.py::TestOAuthUrls::test_github_oauth_url_structure PASSED [ 29%]
tests/test_auth.py::TestTokenGeneration::test_secure_token_generation PASSED [ 32%]
tests/test_auth.py::TestTokenGeneration::test_tokens_are_unique PASSED   [ 35%]
tests/test_pricing.py::TestBlackScholes::test_at_the_money_call PASSED   [ 38%]
tests/test_pricing.py::TestBlackScholes::test_at_the_money_put PASSED    [ 41%]
tests/test_pricing.py::TestBlackScholes::test_put_call_parity PASSED     [ 44%]
tests/test_pricing.py::TestBlackScholes::test_deep_itm_call PASSED       [ 47%]
tests/test_pricing.py::TestBlackScholes::test_deep_otm_call PASSED       [ 50%]
tests/test_pricing.py::TestBlackScholes::test_zero_time_call PASSED      [ 52%]
tests/test_pricing.py::TestCrankNicolson::test_accuracy_vs_analytical_call FAILED [ 55%]
tests/test_pricing.py::TestCrankNicolson::test_accuracy_vs_analytical_put FAILED [ 58%]
tests/test_pricing.py::TestCrankNicolson::test_grid_convergence FAILED   [ 61%]
tests/test_pricing.py::TestMonteCarlo::test_accuracy_vs_analytical PASSED [ 64%]
tests/test_pricing.py::TestMonteCarlo::test_antithetic_reduces_variance PASSED [ 67%]
tests/test_pricing.py::TestMonteCarlo::test_reproducibility_with_seed PASSED [ 70%]
tests/test_pricing.py::TestTrinomialTree::test_accuracy_vs_analytical PASSED [ 73%]
tests/test_pricing.py::TestTrinomialTree::test_richardson_extrapolation_improves_accuracy PASSED [ 76%]
tests/test_pricing.py::TestNumericalMethodComparator::test_all_methods_return_results FAILED [ 79%]
tests/test_pricing.py::TestNumericalMethodComparator::test_timing_information FAILED [ 82%]
tests/test_pricing.py::TestEdgeCases::test_high_volatility PASSED        [ 85%]
tests/test_pricing.py::TestEdgeCases::test_very_short_maturity PASSED    [ 88%]
tests/test_pricing.py::TestEdgeCases::test_zero_rate PASSED              [ 91%]
tests/test_trading_validation.py::test_sell_order_insufficient_position ERROR [ 94%]
tests/test_trading_validation.py::test_sell_order_sufficient_position ERROR [ 97%]
tests/test_trading_validation.py::test_sell_order_partial_insufficient_position ERROR [100%]

==================================== ERRORS ====================================
___________ ERROR at setup of test_sell_order_insufficient_position ____________
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_sell_order_insufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
____________ ERROR at setup of test_sell_order_sufficient_position _____________
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_sell_order_sufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
_______ ERROR at setup of test_sell_order_partial_insufficient_position ________
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:458: in setup
    return super().setup()
           ^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/pytest_asyncio/plugin.py:728: in pytest_fixture_setup
    return (yield)
            ^^^^^
E   pytest.PytestRemovedIn9Warning: 'test_sell_order_partial_insufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
E   See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
=================================== FAILURES ===================================
____________________ TestUserModels.test_user_create_valid _____________________
tests/test_auth.py:18: in test_user_create_valid
    from src.api.main import UserCreate
E   ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
_________________ TestUserModels.test_user_create_default_role _________________
tests/test_auth.py:29: in test_user_create_default_role
    from src.api.main import UserCreate
E   ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
________________ TestUserModels.test_user_create_invalid_email _________________
tests/test_auth.py:35: in test_user_create_invalid_email
    from src.api.main import UserCreate
E   ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
________________ TestUserModels.test_user_create_short_password ________________
tests/test_auth.py:42: in test_user_create_short_password
    from src.api.main import UserCreate
E   ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
_________________ TestUserModels.test_user_create_invalid_role _________________
tests/test_auth.py:49: in test_user_create_invalid_role
    from src.api.main import UserCreate
E   ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
_________________ TestPricingModels.test_pricing_request_valid _________________
tests/test_auth.py:64: in test_pricing_request_valid
    from src.api.main import PricingRequest
E   ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
_____________ TestPricingModels.test_pricing_request_invalid_spot ______________
tests/test_auth.py:78: in test_pricing_request_invalid_spot
    from src.api.main import PricingRequest
E   ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
__________ TestPricingModels.test_pricing_request_invalid_option_type __________
tests/test_auth.py:92: in test_pricing_request_invalid_option_type
    from src.api.main import PricingRequest
E   ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
______________ TestCrankNicolson.test_accuracy_vs_analytical_call ______________
tests/test_pricing.py:98: in test_accuracy_vs_analytical_call
    fdm = crank_nicolson_price(SPOT, STRIKE, RATE, VOLATILITY, TIME, "call", M=200)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:151: in crank_nicolson_price
    rhs[1:-1] = B_lower[1:-1] * V[1:-2] + B_diag[1:-1] * V[2:-1] + B_upper[1:-1] * V[3:-1]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: operands could not be broadcast together with shapes (196,) (198,)
______________ TestCrankNicolson.test_accuracy_vs_analytical_put _______________
tests/test_pricing.py:106: in test_accuracy_vs_analytical_put
    fdm = crank_nicolson_price(SPOT, STRIKE, RATE, VOLATILITY, TIME, "put", M=200)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:151: in crank_nicolson_price
    rhs[1:-1] = B_lower[1:-1] * V[1:-2] + B_diag[1:-1] * V[2:-1] + B_upper[1:-1] * V[3:-1]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: operands could not be broadcast together with shapes (196,) (198,)
___________________ TestCrankNicolson.test_grid_convergence ____________________
tests/test_pricing.py:115: in test_grid_convergence
    coarse = crank_nicolson_price(SPOT, STRIKE, RATE, VOLATILITY, TIME, "call", M=50)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:151: in crank_nicolson_price
    rhs[1:-1] = B_lower[1:-1] * V[1:-2] + B_diag[1:-1] * V[2:-1] + B_upper[1:-1] * V[3:-1]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: operands could not be broadcast together with shapes (46,) (48,)
________ TestNumericalMethodComparator.test_all_methods_return_results _________
tests/test_pricing.py:204: in test_all_methods_return_results
    results = comparator.compare_all(SPOT, STRIKE, RATE, VOLATILITY, TIME, "call")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:362: in compare_all
    fdm = crank_nicolson_price(S, K, r, sigma, T, option_type, M=self.fdm_grid_size)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:151: in crank_nicolson_price
    rhs[1:-1] = B_lower[1:-1] * V[1:-2] + B_diag[1:-1] * V[2:-1] + B_upper[1:-1] * V[3:-1]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: operands could not be broadcast together with shapes (96,) (98,)
____________ TestNumericalMethodComparator.test_timing_information _____________
tests/test_pricing.py:219: in test_timing_information
    results = comparator.compare_all(SPOT, STRIKE, RATE, VOLATILITY, TIME, "call")
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:362: in compare_all
    fdm = crank_nicolson_price(S, K, r, sigma, T, option_type, M=self.fdm_grid_size)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
src/pricing/numerical_methods.py:151: in crank_nicolson_price
    rhs[1:-1] = B_lower[1:-1] * V[1:-2] + B_diag[1:-1] * V[2:-1] + B_upper[1:-1] * V[3:-1]
                ^^^^^^^^^^^^^^^^^^^^^^^
E   ValueError: operands could not be broadcast together with shapes (196,) (198,)
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854
  /app/.venv/lib/python3.12/site-packages/passlib/utils/__init__.py:854: DeprecationWarning: 'crypt' is deprecated and slated for removal in Python 3.13
    from crypt import crypt as _crypt

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_auth.py::TestUserModels::test_user_create_valid - ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestUserModels::test_user_create_default_role - ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestUserModels::test_user_create_invalid_email - ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestUserModels::test_user_create_short_password - ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestUserModels::test_user_create_invalid_role - ImportError: cannot import name 'UserCreate' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestPricingModels::test_pricing_request_valid - ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestPricingModels::test_pricing_request_invalid_spot - ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_auth.py::TestPricingModels::test_pricing_request_invalid_option_type - ImportError: cannot import name 'PricingRequest' from 'src.api.main' (/app/src/api/main.py)
FAILED tests/test_pricing.py::TestCrankNicolson::test_accuracy_vs_analytical_call - ValueError: operands could not be broadcast together with shapes (196,) (198,)
FAILED tests/test_pricing.py::TestCrankNicolson::test_accuracy_vs_analytical_put - ValueError: operands could not be broadcast together with shapes (196,) (198,)
FAILED tests/test_pricing.py::TestCrankNicolson::test_grid_convergence - ValueError: operands could not be broadcast together with shapes (46,) (48,)
FAILED tests/test_pricing.py::TestNumericalMethodComparator::test_all_methods_return_results - ValueError: operands could not be broadcast together with shapes (96,) (98,)
FAILED tests/test_pricing.py::TestNumericalMethodComparator::test_timing_information - ValueError: operands could not be broadcast together with shapes (196,) (198,)
ERROR tests/test_trading_validation.py::test_sell_order_insufficient_position - pytest.PytestRemovedIn9Warning: 'test_sell_order_insufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
ERROR tests/test_trading_validation.py::test_sell_order_sufficient_position - pytest.PytestRemovedIn9Warning: 'test_sell_order_sufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
ERROR tests/test_trading_validation.py::test_sell_order_partial_insufficient_position - pytest.PytestRemovedIn9Warning: 'test_sell_order_partial_insufficient_position' requested an async fixture 'db_session', with no plugin or hook that handled it. This is usually an error, as pytest does not natively support it. This will turn into an error in pytest 9.
See: https://docs.pytest.org/en/stable/deprecations.html#sync-test-depending-on-async-fixture
============== 13 failed, 18 passed, 1 warning, 3 errors in 2.83s ==============

Tests finished with exit code 1
